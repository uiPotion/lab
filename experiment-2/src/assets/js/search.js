// Lunr.js Search Implementation for Harold Blog
// Reads from jsonData/posts.json generated by Harold

(function() {
  'use strict';

  const searchInput = document.getElementById('search-input');
  const searchForm = document.getElementById('search-form');
  const searchResults = document.getElementById('search-results');
  const searchStatus = document.getElementById('search-status');
  const searchPopular = document.getElementById('search-popular');

  let posts = [];
  let idx = null;
  let isInitialized = false;

  // Get the base path for relative links
  function getBasePath() {
    const path = window.location.pathname;
    // Handle both /search.html and /search/index.html cases
    if (path.includes('/search/') || path.endsWith('/search.html')) {
      return './';
    }
    const depth = path.split('/').filter(Boolean).length;
    return depth > 0 ? '../'.repeat(depth) : './';
  }

  // Format date helper
  function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return '';
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }

  // Get the correct URL for a post based on Harold's fileName field
  function getPostUrl(post, basePath) {
    // Harold's posts.json uses 'fileName' field (e.g., "my-post.html")
    if (post.fileName) {
      return basePath + 'posts/' + post.fileName;
    }
    // Fallback: try other common fields
    if (post.link) {
      return post.link.startsWith('http') ? post.link : basePath + post.link;
    }
    if (post.url) {
      return post.url.startsWith('http') ? post.url : basePath + post.url;
    }
    // Last resort: generate from title
    const slug = (post.title || 'untitled').toLowerCase().replace(/[^a-z0-9]+/g, '-');
    return basePath + 'posts/' + slug + '.html';
  }

  // Get unique identifier for Lunr index from a post
  function getPostId(post) {
    // Use fileName as the unique ID since it's guaranteed to exist and be unique
    if (post.fileName) {
      return post.fileName.replace(/\.html?$/, '');
    }
    if (post.slug) return post.slug;
    if (post.id) return post.id;
    return (post.title || 'untitled').toLowerCase().replace(/[^a-z0-9]+/g, '-');
  }

  // Initialize search index
  async function initSearch() {
    try {
      console.log('Initializing search...');
      const basePath = getBasePath();
      const jsonUrl = basePath + 'jsonData/posts.json';
      console.log('Fetching posts from:', jsonUrl);
      
      const response = await fetch(jsonUrl);
      
      if (!response.ok) {
        throw new Error('Failed to load posts data: ' + response.status + ' ' + response.statusText);
      }

      const data = await response.json();
      console.log('Raw posts data:', data);
      
      // Handle different possible structures of the JSON data
      if (Array.isArray(data)) {
        posts = data;
      } else if (data.posts && Array.isArray(data.posts)) {
        posts = data.posts;
      } else if (data.data && Array.isArray(data.data)) {
        posts = data.data;
      } else {
        console.error('Unexpected data structure:', data);
        posts = [];
      }
      
      console.log('Posts loaded:', posts.length);
      console.log('First post sample:', posts[0]);

      if (posts.length === 0) {
        if (searchStatus) {
          searchStatus.textContent = 'No posts available for search.';
        }
        return;
      }

      // Normalize post data - add computed id field for Lunr
      posts = posts.map(post => ({
        ...post,
        _id: getPostId(post)
      }));
      
      console.log('Normalized posts:', posts.map(p => ({ title: p.title, fileName: p.fileName, _id: p._id })));

      // Build Lunr index
      idx = lunr(function() {
        this.ref('_id');
        this.field('title', { boost: 10 });
        this.field('excerpt', { boost: 5 });
        this.field('tags', { boost: 3 });
        this.field('body');

        posts.forEach(post => {
          const doc = {
            _id: post._id,
            title: post.title || '',
            excerpt: post.excerpt || post.description || '',
            tags: Array.isArray(post.tags) ? post.tags.join(' ') : (post.tags || ''),
            body: post.body || post.content || post.excerpt || post.description || ''
          };
          console.log('Adding to index:', doc._id, doc.title);
          this.add(doc);
        });
      });

      console.log('Lunr index built successfully');
      isInitialized = true;

      // Check for query param on load
      const params = new URLSearchParams(window.location.search);
      const query = params.get('q');
      if (query && searchInput) {
        searchInput.value = query;
        performSearch(query);
      }

    } catch (error) {
      console.error('Search initialization error:', error);
      if (searchStatus) {
        searchStatus.textContent = 'Search is currently unavailable. Please try again later.';
        searchStatus.style.color = 'var(--color-error)';
      }
    }
  }

  // Perform search
  function performSearch(query) {
    console.log('Performing search for:', query);
    
    if (!isInitialized || !idx) {
      console.log('Search not initialized yet');
      if (searchStatus) {
        searchStatus.textContent = 'Search is loading... Please try again in a moment.';
      }
      return;
    }

    const trimmedQuery = query.trim();
    
    if (!trimmedQuery) {
      if (searchResults) searchResults.innerHTML = '';
      if (searchStatus) searchStatus.textContent = '';
      if (searchPopular) searchPopular.style.display = 'block';
      return;
    }

    try {
      const results = idx.search(trimmedQuery);
      console.log('Search results:', results);
      renderResults(results, trimmedQuery);
    } catch (error) {
      console.error('Search error:', error);
      if (searchStatus) {
        searchStatus.textContent = 'An error occurred while searching. Please try again.';
      }
    }
  }

  // Render search results - with images and cards
  function renderResults(results, query) {
    console.log('Rendering', results.length, 'results for query:', query);
    
    if (!searchResults || !searchStatus) {
      console.error('Search DOM elements not found');
      return;
    }

    const basePath = getBasePath();

    // Hide popular topics, show results container
    if (searchPopular) searchPopular.style.display = 'none';
    searchResults.style.display = 'flex';

    if (results.length === 0) {
      searchStatus.textContent = 'No results found for "' + query + '"';
      searchResults.innerHTML = '<div class="search-empty"><p>We couldn\'t find any articles matching your search.</p><p>Try different keywords or check out the <a href="' + basePath + 'categories.html">categories page</a>.</p></div>';
      return;
    }

    searchStatus.textContent = 'Found ' + results.length + ' result' + (results.length === 1 ? '' : 's') + ' for "' + query + '"';

    try {
      // Use search-result-item structure with images for beautiful cards
      const html = results.map(function(result) {
        const post = posts.find(function(p) { return p._id === result.ref; });
        
        if (!post) {
          console.warn('Post not found for _id:', result.ref);
          return '';
        }

        console.log('Rendering post:', post.title, 'fileName:', post.fileName);
        
        // Build post URL using Harold's fileName field
        const postUrl = getPostUrl(post, basePath);
        
        // Handle cover image
        let imageHtml = '';
        const coverImage = post.coverImage || post.image || post.featuredImage;
        if (coverImage) {
          const imageUrl = coverImage.startsWith('http') ? coverImage : basePath + coverImage;
          imageHtml = '<div class="search-result-image"><img src="' + imageUrl + '" alt="' + escapeHtml(post.title || '') + '" loading="lazy"></div>';
        }
        
        // Handle date - try various field names
        const dateValue = post.publicationDate || post.date || post.published || post.created;
        const dateHtml = dateValue ? '<span class="search-result-date">' + formatDate(dateValue) + '</span>' : '';
        
        // Handle tags
        let tagHtml = '';
        if (post.tags && Array.isArray(post.tags) && post.tags.length > 0) {
          tagHtml = '<span class="search-result-tag">' + escapeHtml(post.tags[0]) + '</span>';
        }
        
        // Highlight matches in title and excerpt
        const titleHtml = highlightMatch(post.title || 'Untitled', query);
        const excerptText = post.excerpt || post.description || '';
        const excerptHtml = highlightMatch(excerptText.substring(0, 200) + (excerptText.length > 200 ? '...' : ''), query);

        return '<article class="search-result-item">' +
          imageHtml +
          '<div class="search-result-content">' +
            '<div class="search-result-meta">' +
              tagHtml +
              dateHtml +
            '</div>' +
            '<h3 class="search-result-title"><a href="' + postUrl + '">' + titleHtml + '</a></h3>' +
            '<p class="search-result-excerpt">' + excerptHtml + '</p>' +
          '</div>' +
        '</article>';
      }).join('');

      searchResults.innerHTML = html || '<div class="search-empty"><p>No results could be displayed.</p></div>';
      console.log('Results rendered successfully');
      
    } catch (error) {
      console.error('Error rendering results:', error);
      searchStatus.textContent = 'Error displaying results. Please try again.';
      searchResults.innerHTML = '<div class="search-empty"><p>Error loading results. Please try again.</p></div>';
    }
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    if (!text) return '';
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  // Highlight search terms in text
  function highlightMatch(text, query) {
    if (!text || !query) return escapeHtml(text);
    
    try {
      let escapedText = escapeHtml(text);
      const terms = query.toLowerCase().split(/\s+/).filter(function(t) { return t.length > 0; });
      
      terms.forEach(function(term) {
        if (term.length === 0) return;
        const regex = new RegExp('(' + escapeRegex(term) + ')', 'gi');
        escapedText = escapedText.replace(regex, '<mark class="search-highlight">$1</mark>');
      });
      
      return escapedText;
    } catch (error) {
      console.error('Highlight error:', error);
      return escapeHtml(text);
    }
  }

  // Escape special regex characters
  function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // Event listeners
  if (searchForm) {
    searchForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const query = searchInput ? searchInput.value : '';
      performSearch(query);
      
      // Update URL with search query
      const params = new URLSearchParams(window.location.search);
      if (query.trim()) {
        params.set('q', query.trim());
      } else {
        params.delete('q');
      }
      const newUrl = params.toString() 
        ? window.location.pathname + '?' + params.toString()
        : window.location.pathname;
      window.history.replaceState({}, '', newUrl);
    });
  }

  if (searchInput) {
    let debounceTimer;
    searchInput.addEventListener('input', function(e) {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(function() {
        performSearch(e.target.value);
      }, 300);
    });
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearch);
  } else {
    initSearch();
  }
})();
